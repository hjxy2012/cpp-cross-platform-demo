cmake_minimum_required(VERSION 3.16)
project(CrossPlatformCalculator VERSION 1.0.0 LANGUAGES CXX)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ç‰ˆæœ¬ä¿¡æ¯
if(DEFINED APP_VERSION)
    set(PROJECT_VERSION ${APP_VERSION})
    message(STATUS "Building version: ${APP_VERSION}")
endif()

# ç¼–è¯‘å™¨ç‰¹å®šè®¾ç½®
if(MSVC)
    # Windows MSVC
    add_compile_options(/W4)
    # é™æ€é“¾æ¥è¿è¡Œæ—¶åº“
    set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    # GCC æˆ– Clang
    add_compile_options(-Wall -Wextra -pedantic)
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šWindows MinGWé™æ€é“¾æ¥é…ç½®
    if(WIN32)
        # Windowsä¸‹ä½¿ç”¨MinGWæ—¶é™æ€é“¾æ¥è¿è¡Œæ—¶åº“
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static-libgcc -static-libstdc++ -static")
        message(STATUS "Windows MinGW: å¯ç”¨é™æ€é“¾æ¥ä»¥é¿å…è¿è¡Œæ—¶ä¾èµ–")
    elseif(UNIX AND NOT APPLE)
        # Linuxä¸‹é™æ€é“¾æ¥
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static-libgcc -static-libstdc++")
    endif()
endif()

# åŒ…å«ç›®å½•
include_directories(include)

# æºæ–‡ä»¶
set(SOURCES
    src/main.cpp
    src/calculator.cpp
)

set(HEADERS
    include/calculator.h
)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(${PROJECT_NAME} ${SOURCES} ${HEADERS})

# è®¾ç½®è¾“å‡ºåç§°
set_target_properties(${PROJECT_NAME} PROPERTIES
    OUTPUT_NAME "calculator"
    VERSION ${PROJECT_VERSION}
)

# ä¼ é€’ç‰ˆæœ¬ä¿¡æ¯åˆ°ä»£ç 
target_compile_definitions(${PROJECT_NAME} PRIVATE 
    APP_VERSION="${PROJECT_VERSION}"
)

# Windowsç‰¹å®šè®¾ç½®
if(WIN32)
    # è®¾ç½®æ§åˆ¶å°åº”ç”¨ç¨‹åº
    set_target_properties(${PROJECT_NAME} PROPERTIES
        WIN32_EXECUTABLE FALSE
    )
    
    # åˆ›å»ºç‰ˆæœ¬èµ„æºæ–‡ä»¶
    configure_file(
        "${CMAKE_CURRENT_SOURCE_DIR}/version.rc.in"
        "${CMAKE_CURRENT_BINARY_DIR}/version.rc"
        @ONLY
    )
    
    # å¦‚æœç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨ï¼Œæ·»åŠ åˆ°æºæ–‡ä»¶
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/version.rc.in")
        target_sources(${PROJECT_NAME} PRIVATE "${CMAKE_CURRENT_BINARY_DIR}/version.rc")
    endif()
endif()

# å®‰è£…è§„åˆ™
install(TARGETS ${PROJECT_NAME}
    RUNTIME DESTINATION bin
    COMPONENT Runtime
)

# å®‰è£…æ–‡æ¡£
install(FILES 
    README.md
    DESTINATION .
    COMPONENT Documentation
    OPTIONAL
)

# CPacké…ç½®
set(CPACK_PACKAGE_NAME "CrossPlatformCalculator")
set(CPACK_PACKAGE_VERSION ${PROJECT_VERSION})
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "A cross-platform calculator built with C++ and CMake")
set(CPACK_PACKAGE_VENDOR "hjxy2012")
set(CPACK_PACKAGE_CONTACT "hjxy2012@gmail.com")
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_CURRENT_SOURCE_DIR}/LICENSE")
set(CPACK_RESOURCE_FILE_README "${CMAKE_CURRENT_SOURCE_DIR}/README.md")

# å¹³å°ç‰¹å®šçš„æ‰“åŒ…å™¨
if(WIN32)
    set(CPACK_GENERATOR "ZIP;NSIS")
    set(CPACK_NSIS_DISPLAY_NAME "Cross-Platform Calculator")
    set(CPACK_NSIS_PACKAGE_NAME "Calculator")
    set(CPACK_NSIS_CONTACT "hjxy2012@gmail.com")
    set(CPACK_NSIS_HELP_LINK "https://github.com/yourusername/cpp-cross-platform-demo")
    set(CPACK_NSIS_URL_INFO_ABOUT "https://github.com/yourusername/cpp-cross-platform-demo")
    
elseif(APPLE)
    set(CPACK_GENERATOR "TGZ;DragNDrop")
    set(CPACK_DMG_FORMAT "UDBZ")
    set(CPACK_DMG_VOLUME_NAME "Calculator")
    
elseif(UNIX)
    set(CPACK_GENERATOR "TGZ;DEB;RPM")
    
    # DEBåŒ…è®¾ç½®
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "libc6 (>= 2.17), libstdc++6 (>= 5.4.0)")
    set(CPACK_DEBIAN_PACKAGE_MAINTAINER "CrossPlatform Calculator Team <hjxy2012@gmail.com>")
    set(CPACK_DEBIAN_PACKAGE_DESCRIPTION "Cross-Platform Calculator
 A simple calculator application built with C++ and CMake.
 Supports basic arithmetic operations: addition, subtraction, 
 multiplication, and division.")
    set(CPACK_DEBIAN_PACKAGE_SECTION "utils")
    set(CPACK_DEBIAN_PACKAGE_PRIORITY "optional")
    
    # RPMåŒ…è®¾ç½®
    set(CPACK_RPM_PACKAGE_SUMMARY "Cross-platform calculator application")
    set(CPACK_RPM_PACKAGE_DESCRIPTION "A simple calculator application built with C++ and CMake")
    set(CPACK_RPM_PACKAGE_GROUP "Applications/Engineering")
    set(CPACK_RPM_PACKAGE_LICENSE "MIT")
endif()

# è®¾ç½®ç»„ä»¶
set(CPACK_COMPONENTS_ALL Runtime Documentation)
set(CPACK_COMPONENT_RUNTIME_DISPLAY_NAME "Calculator Application")
set(CPACK_COMPONENT_RUNTIME_DESCRIPTION "The main calculator executable")
set(CPACK_COMPONENT_DOCUMENTATION_DISPLAY_NAME "Documentation")
set(CPACK_COMPONENT_DOCUMENTATION_DESCRIPTION "README and license files")

# åŒ…å«CPackæ¨¡å—ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰CPackå˜é‡è®¾ç½®ä¹‹åï¼‰
include(CPack)